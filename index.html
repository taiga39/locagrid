<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Location Grid with Map</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <style>
        .container {
            position: relative;
            height: 100vh;
            width: 100%;
            margin: 0;
            padding: 0;
        }
        .controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .grid {
            position: absolute;
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 1px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 999;
            width: 240px;
            height: 240px;
            pointer-events: none;
        }
        .cell {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(0, 0, 0, 0.2);
        }
        .current {
            background: rgba(59, 130, 246, 0.6);
            border: 2px solid rgba(59, 130, 246, 0.8);
        }
        .accuracy {
            margin: 5px 0;
        }
        .good { color: green; }
        .normal { color: orange; }
        .bad { color: red; }
        #map {
            height: 100%;
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="controls">
            <button onclick="startTracking()">位置測定を開始</button>
            <div class="accuracy"></div>
            <div class="position"></div>
        </div>
        <div id="map"></div>
        <div class="grid">
            <!-- 8x8=64のセルをJavaScriptで生成 -->
        </div>
    </div>

    <script>
        let basePosition = null;
        let map = null;
        let marker = null;
        const GRID_SIZE = 8;
        const CELL_SIZE = 30; // 30メートル

        // グリッドの生成
        const grid = document.querySelector('.grid');
        for (let i = 0; i < 64; i++) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            grid.appendChild(cell);
        }

        // 地図の初期化
        function initMap(lat, lng) {
            if (map === null) {
                map = L.map('map').setView([lat, lng], 19);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                }).addTo(map);
                marker = L.marker([lat, lng]).addTo(map);
            } else {
                map.setView([lat, lng], 19);
                marker.setLatLng([lat, lng]);
            }
        }

        function startTracking() {
            const button = document.querySelector('button');
            if ("geolocation" in navigator) {
                button.textContent = "位置情報を取得中...";
                button.disabled = true;
                navigator.geolocation.getCurrentPosition(
                    pos => {
                    basePosition = {
                        lat: pos.coords.latitude,
                        lng: pos.coords.longitude
                    };
                    
                    // 地図の初期化
                    initMap(basePosition.lat, basePosition.lng);
                    
                    // 位置の継続的な監視を開始
                    navigator.geolocation.watchPosition(updatePosition, null, {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    });
                    },
                    (error) => {
                        button.textContent = "位置測定を開始";
                        button.disabled = false;
                        alert("位置情報の取得に失敗しました。設定で位置情報の利用を許可してください。");
                    }
                );
            }
        }

        function updatePosition(pos) {
            const accuracy = pos.coords.accuracy;
            const accuracyDiv = document.querySelector('.accuracy');
            
            // 精度の表示更新
            let accuracyClass = 'bad';
            let accuracyText = '要注意';
            if (accuracy <= 10) {
                accuracyClass = 'good';
                accuracyText = 'とても良好';
            } else if (accuracy <= 20) {
                accuracyClass = 'normal';
                accuracyText = '普通';
            }
            accuracyDiv.className = `accuracy ${accuracyClass}`;
            accuracyDiv.textContent = `精度: ${Math.round(accuracy)}m (${accuracyText})`;

            // グリッド位置の計算
            const gridX = Math.floor((pos.coords.longitude - basePosition.lng) / (CELL_SIZE / 111320));
            const gridY = Math.floor((pos.coords.latitude - basePosition.lat) / (CELL_SIZE / 111320));

            // 現在位置の表示更新
            document.querySelectorAll('.cell').forEach(cell => cell.classList.remove('current'));
            if (gridX >= 0 && gridX < GRID_SIZE && gridY >= 0 && gridY < GRID_SIZE) {
                const index = gridY * GRID_SIZE + gridX;
                document.querySelectorAll('.cell')[index].classList.add('current');
                
                document.querySelector('.position').textContent = 
                    `現在位置: グリッド(${gridX}, ${gridY})`;
            }

            // 地図の更新
            if (marker) {
                marker.setLatLng([pos.coords.latitude, pos.coords.longitude]);
                map.panTo([pos.coords.latitude, pos.coords.longitude]);
            }
        }
    </script>
</body>
</html>